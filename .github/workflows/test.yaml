name: Test

on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - .github/workflows/test.yaml
      - src/**/*.py
      - pyproject.toml
      - uv.lock
      - ./**/*.yml
      - ./**/*.yaml

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v3

      - name: Install a specific version of uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.6.10"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Check uv.lock
        run: |
          if ! git diff --exit-code uv.lock > /dev/null; then
            echo "❌ uv.lock is out of sync with pyproject.toml. Run 'uv sync' and commit the updated lockfile."
            git diff uv.lock
            exit 1
          fi

      - name: Install system deps
        uses: awalsh17/cache-apt-pkgs-action@latest
        with:
          packages: curl gnupg software-properties-common jq unzip gdal-bin libgdal-dev gettext

      - name: Export GDAL path
        run: |
          echo "GDAL_LIBRARY_PATH=$(gdal-config --libs | grep -o '/[^ ]*libgdal[^ ]*\.so')" >> $GITHUB_ENV

      - name: Recreate environment file
        run: cp .env.example .env

      - name: Disable observability for tests
        run: |
          # Disable observability in CI - no Loki/Tempo/Prometheus services running
          echo "ENABLE_OBSERVABILITY=False" >> .env
          echo "Observability disabled for CI tests"

      - name: Add worldcities.csv  # we need this so migrations can run
        working-directory: src
        run: cp geo/data/worldcities.mini.csv geo/data/worldcities.csv

      - name: Run ruff formatting check
        run: uv run ruff format --check .

      - name: Run ruff linting check
        run: uv run ruff check .

      - name: Run mypy
        run: uv run mypy --strict --extra-checks --warn-unreachable --warn-unused-ignores src

      - name: Check file length (max 1000 lines)
        run: ./scripts/check-file-length.sh 1000

      - name: Spin up docker
        run: docker compose -f docker-compose-ci.yml up -d

      - name: Check for missing migrations
        working-directory: src
        run: uv run manage.py makemigrations --check --dry-run --no-input

      - name: Check i18n compiled messages
        run: |
          uv run python src/manage.py compilemessages
          if ! git diff --exit-code src/locale/ > /dev/null; then
            echo "❌ Translation files (.mo) are out of sync with .po files. Run 'make compilemessages' and commit the updated .mo files."
            git diff src/locale/
            exit 1
          fi

      - name: Run unit tests
        run: |
          uv run pytest -n auto --cov=src --cov-report=term --cov-report=html --cov-branch --cov-fail-under=90 --junitxml=test-results/unit-tests.xml -v src

      - name: Teardown docker
        run: docker compose -f docker-compose-ci.yml down

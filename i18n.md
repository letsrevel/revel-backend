# Internationalization (i18n) Guide

This document explains how Revel's internationalization system works and how to add support for new languages.

## Overview

Revel uses Django's built-in internationalization framework to support multiple languages. All user-facing strings (API responses, error messages, email templates) are translatable.

**Currently supported languages:**
- English (en) - Default
- German (de) - Informal "du" form
- Italian (it) - Informal "tu" form

## How It Works

### 1. User Language Preference

Each user has a `language` field in their profile that stores their preferred language (see `src/accounts/models.py:37-43`). The available choices come from `settings.LANGUAGES`.

### 2. Automatic Language Activation (JWT Authentication)

Language activation happens automatically during JWT authentication using the `I18nJWTAuth` authentication class (in `src/common/authentication.py`).

**How it works:**
1. When a request comes in with a JWT token, `I18nJWTAuth` validates the token
2. After successful validation, it retrieves the user from the database
3. It activates the user's preferred language using Django's `translation.activate()`
4. All subsequent code in the request (controllers, services, templates) uses the user's language

**Example:**
```python
from common.authentication import I18nJWTAuth

@route.get("/endpoint", auth=I18nJWTAuth())
def my_endpoint(request):
    # User's language is already activated here
    return ResponseMessage(message=str(_("Success!")))
```

**For optional authentication** (public endpoints that work with or without a token):
```python
from common.authentication import OptionalAuth

@api_controller("/events", auth=OptionalAuth())
class EventController:
    def list_events(self, request):
        # Works for both authenticated and anonymous users
        # If authenticated, language is activated automatically
        user = request.user  # Could be RevelUser or AnonymousUser
```

**Note:** The `UserLanguageMiddleware` in `src/common/middleware.py` is NOT used for JWT authentication. It only applies to session-based authentication, which this project doesn't use.

### 3. Translation in Code

All user-facing strings are wrapped with Django's translation functions:

```python
from django.utils.translation import gettext_lazy as _

# Simple string
raise HttpError(400, str(_("Invalid OTP.")))

# String with variables
raise HttpError(400, str(_("Invalid token: {error}")).format(error=e))
```

### 4. Translation in Templates

Email templates use Django's i18n template tags:

```django
{% load i18n %}

{# Simple translation #}
<h1>{% trans "Payment Successful!" %}</h1>

{# Translation with variables #}
<p>{% blocktrans %}Hi {{ user_name }},{% endblocktrans %}</p>
```

## Adding a New Language

Follow these steps to add support for a new language:

### Step 1: Update Settings

Add the new language to `LANGUAGES` in `src/revel/settings/base.py`:

```python
LANGUAGES = [
    ("en", "English"),
    ("de", "Deutsch"),
    ("it", "Italiano"),
    ("fr", "Français"),  # Adding French
]
```

### Step 2: Generate Translation Files

Run the `makemessages` command to create a new `.po` file for your language. First, update the Makefile to include the new language:

```makefile
# In Makefile
.PHONY: makemessages
makemessages:
	cd src && ../.venv/bin/python manage.py makemessages -l de -l it -l fr --no-location --no-obsolete
```

Then run:

```bash
make makemessages
```

This creates `src/locale/fr/LC_MESSAGES/django.po`.

**Command options explained:**
- `-l fr` - Language code (use ISO 639-1 codes)
- `--no-location` - Don't include file locations in comments (keeps files cleaner)
- `--no-obsolete` - Remove outdated translations

### Step 3: Translate Strings

Open the generated `.po` file and translate each `msgid` to your target language:

```po
msgid "Your data export has been initiated."
msgstr "Votre exportation de données a été lancée."
```

**Translation guidelines:**
- Use informal forms (tu/du) rather than formal (vous/Sie)
- Use gender-inclusive language where possible
- Keep technical terms and brand names untranslated (Revel, Stripe, Google, TOTP, OTP)
- Preserve HTML tags, variables (`{{ variable }}`), and format strings (`{error}`)
- Be natural and idiomatic in the target language

### Step 4: Compile Translations

Compile the `.po` file into a binary `.mo` file that Django can use:

```bash
make compilemessages
```

This creates `src/locale/fr/LC_MESSAGES/django.mo`.

**IMPORTANT:** The `.mo` files are committed to version control (unlike traditional Django projects). This ensures:
- Reproducible builds across all environments
- Docker builds work without gettext tools
- Consistent translations for all developers
- CI can verify translations are properly compiled

### Step 5: Test

1. Create or update a user account with the new language preference
2. Make API requests as that user
3. Verify that responses are in the correct language

## Updating Existing Translations

When you add new user-facing strings or modify existing ones:

### Step 1: Update Translation Files

Regenerate the `.po` files to include new strings:

```bash
make makemessages
```

### Step 2: Translate New Strings

Open each `.po` file and find empty `msgstr` entries:

```po
msgid "New feature message"
msgstr ""  # Add translation here
```

### Step 3: Recompile and Commit

```bash
make compilemessages
git add src/locale/
git commit -m "Update translations"
```

**IMPORTANT:** Always run `make compilemessages` and commit the `.mo` files after editing `.po` files. The CI pipeline will fail if the `.mo` files are out of sync.

## Best Practices for Developers

### DO:

✅ **Use `I18nJWTAuth` for all authenticated endpoints:**
```python
from common.authentication import I18nJWTAuth

@route.get("/endpoint", auth=I18nJWTAuth())
def my_endpoint(request):
    ...
```

✅ **Use `gettext_lazy` for all user-facing strings in Python code:**
```python
from django.utils.translation import gettext_lazy as _
error_message = str(_("Invalid input"))
```

✅ **Use `{% trans %}` and `{% blocktrans %}` in templates:**
```django
{% load i18n %}
{% trans "Welcome!" %}
{% blocktrans %}Hello {{ name }}{% endblocktrans %}
```

✅ **Always wrap the lazy translation with `str()` when returning in API responses:**
```python
return ResponseMessage(message=str(_("Success!")))
```

✅ **Use format strings for dynamic values:**
```python
str(_("Error: {error}")).format(error=details)
```

### DON'T:

❌ **Don't hardcode user-facing strings:**
```python
return {"error": "Invalid input"}  # Bad
```

❌ **Don't translate log messages, internal errors, or developer-facing content:**
```python
logger.info("Processing user data")  # OK - not translated
```

❌ **Don't put template tags inside translation blocks:**
```django
{# Bad - won't work #}
{% blocktrans %}Text {% if condition %}more{% endif %}{% endblocktrans %}

{# Good - move logic outside #}
{% if condition %}
    {% blocktrans %}Text more{% endblocktrans %}
{% else %}
    {% blocktrans %}Text{% endblocktrans %}
{% endif %}
```

❌ **Don't forget to recompile and commit after editing `.po` files:**
```bash
# Always run this after editing translations
make compilemessages
git add src/locale/
```

## Make Commands

The project provides convenient Make commands for i18n workflows:

### `make makemessages`
Extracts translatable strings from code and updates `.po` files for all configured languages (currently German and Italian).

```bash
make makemessages
```

This is equivalent to:
```bash
cd src && python manage.py makemessages -l de -l it --no-location --no-obsolete
```

### `make compilemessages`
Compiles `.po` files into binary `.mo` files that Django uses at runtime.

```bash
make compilemessages
```

**Remember to commit the `.mo` files after running this command!**

### `make i18n-check`
Verifies that `.mo` files are up to date with `.po` files. Fails if recompilation is needed.

```bash
make i18n-check
```

This check is automatically run as part of `make check` and in the CI pipeline.

### `make check`
Runs all code quality checks including i18n verification:

```bash
make check  # Runs: format, lint, mypy, i18n-check
```

## CI Pipeline Integration

The GitHub Actions test workflow includes an i18n check step that:

1. Runs `compilemessages` to generate `.mo` files
2. Checks if any files changed (using `git diff`)
3. Fails the build if `.mo` files are out of sync with `.po` files

This ensures that all translation updates are properly compiled and committed before merging to main.

**How to fix CI failures:**
```bash
make compilemessages
git add src/locale/
git commit -m "Compile translation messages"
git push
```

## File Structure

```
src/
├── locale/                          # Translation files (both .po and .mo are committed)
│   ├── de/                          # German translations
│   │   └── LC_MESSAGES/
│   │       ├── django.po            # Editable translation file
│   │       └── django.mo            # Compiled binary (COMMITTED to git)
│   ├── it/                          # Italian translations
│   │   └── LC_MESSAGES/
│   │       ├── django.po
│   │       └── django.mo            # Compiled binary (COMMITTED to git)
│   └── en/                          # English (optional, for completeness)
│       └── LC_MESSAGES/
│           ├── django.po
│           └── django.mo
├── accounts/
│   ├── models.py                    # User.language field
│   └── templates/
│       └── accounts/emails/         # Translated email templates
├── common/
│   └── middleware.py                # UserLanguageMiddleware
└── revel/settings/base.py           # LANGUAGES configuration
```

## Testing i18n

### Manual Testing

1. **Change user language:**
```python
user = RevelUser.objects.get(email="test@example.com")
user.language = "de"
user.save()
```

2. **Make authenticated API requests:**
```bash
# Get JWT token for user
make jwt EMAIL=test@example.com

# Use token in requests - responses should be in German
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8000/api/account/me
```

### Automated Testing

Example test to verify translations work:

```python
from django.utils import translation
from django.test import TestCase

class I18nTestCase(TestCase):
    def test_error_message_translation(self):
        # Activate German
        with translation.override('de'):
            from accounts.service.account import register_user
            from ninja.errors import HttpError

            # Create a user
            user = create_test_user()

            # Try to register again with same email
            with self.assertRaises(HttpError) as cm:
                register_user(...)

            # Verify error message is in German
            self.assertIn("bereits", str(cm.exception))  # "already" in German
```

## Common Issues

### Issue: Translations not showing up

**Solutions:**
1. Make sure you compiled the messages: `make compilemessages`
2. Verify the `.mo` files exist in `src/locale/{language}/LC_MESSAGES/`
3. Restart the Django development server
4. Check that the user's `language` field is set correctly
5. Verify that `I18nJWTAuth` is being used for authenticated endpoints

### Issue: CI pipeline failing on i18n check

**Problem:** The CI step "Check i18n compiled messages" is failing.

**Solution:**
```bash
# Recompile the messages
make compilemessages

# Verify they're up to date
make i18n-check

# Commit the updated .mo files
git add src/locale/
git commit -m "Update compiled translation files"
```

### Issue: Variables not working in translations

**Problem:**
```python
# Wrong
str(_("Hello {name}"))  # {name} won't be replaced
```

**Solution:**
```python
# Correct
str(_("Hello {name}")).format(name=user.name)
```

### Issue: Template syntax errors when compiling

**Problem:** Translation blocks can't contain template tags like `{% if %}`.

**Solution:** Move the logic outside the translation block or create separate translations for each case.

## Resources

- [Django i18n Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/)
- [Django Translation Documentation](https://docs.djangoproject.com/en/stable/topics/i18n/translation/)
- [GNU gettext](https://www.gnu.org/software/gettext/)
- [ISO 639-1 Language Codes](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes)